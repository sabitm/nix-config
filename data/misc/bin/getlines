#!/usr/bin/env python3
import sys
import os
import linecache

def main():
    # Check if an input file was provided
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <input_file>")
        sys.exit(1)

    input_file = sys.argv[1]

    # Verify input file exists
    if not os.path.exists(input_file):
        print(f"Error: Input file '{input_file}' not found.")
        sys.exit(1)

    try:
        with open(input_file, 'r') as f:
            for entry in f:
                entry = entry.strip()
                if not entry:
                    continue

                # Parse the entry (e.g., "file.go:701:")
                # We split by ':' and expect at least 2 parts (filename and line)
                parts = entry.split(':')

                if len(parts) < 2:
                    print(f"Skipping invalid format: {entry}")
                    continue

                filename = parts[0]
                line_str = parts[1]

                # Validate line number is an integer
                if not line_str.isdigit():
                    print(f"Skipping invalid line number in: {entry}")
                    continue

                linenum = int(line_str)

                # Check if the target source file exists
                if os.path.exists(filename):
                    # linecache.getline returns empty string if line not found
                    # line numbers are 1-based
                    line_content = linecache.getline(filename, linenum)

                    if line_content:
                        # .rstrip() removes the trailing newline from the fetched line
                        print(f"{filename}:{linenum}:{line_content.rstrip()}")
                    else:
                        print(f"Warning: Line {linenum} not found in {filename}")
                else:
                    print(f"Error: Source file '{filename}' not found.")

    except Exception as e:
        print(f"An unexpected error occurred: {e}")
    finally:
        # Good practice to clear the cache if processing many large files
        linecache.clearcache()

if __name__ == "__main__":
    main()
